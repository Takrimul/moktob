<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: base-layout(pageTitle='Attendance - Moktob Management System')}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance - Moktob Management System</title>
</head>
<body>
<div th:fragment="content">
    <!-- Class Selection -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>Select Class
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="classSelect" class="form-label">Choose Class</label>
                        <select class="form-select" id="classSelect" onchange="loadClassStudents()">
                            <option value="">Select a class...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="attendanceDate" class="form-label">Attendance Date</label>
                        <input type="date" class="form-control" id="attendanceDate" onchange="loadClassStudents()">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Class Information
                    </h5>
                </div>
                <div class="card-body" id="classInfo">
                    <p class="text-muted mb-0">Select a class to view information</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Form -->
    <div class="card" id="attendanceFormCard" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-clipboard-list me-2"></i>Mark Attendance
            </h5>
            <div>
                <button type="button" class="btn btn-success btn-sm" onclick="saveAttendance()">
                    <i class="fas fa-save me-1"></i>Save Attendance
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="attendanceTable">
                    <thead class="table-dark">
                        <tr>
                            <th width="5%">#</th>
                            <th width="25%">Student Name</th>
                            <th width="20%">Guardian Name</th>
                            <th width="15%">Guardian Contact</th>
                            <th width="15%">Present</th>
                            <th width="15%">Absent</th>
                            <th width="15%">Late</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <!-- Students will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- No Class Selected Message -->
    <div class="card" id="noClassCard">
        <div class="card-body text-center py-5">
            <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">Select a Class</h4>
            <p class="text-muted">Choose a class and date to start taking attendance</p>
        </div>
    </div>
</div>

<!-- Page Actions -->
<div th:fragment="page-actions">
    <div class="btn-group me-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshAttendance()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>
</div>

<!-- Additional CSS -->
<div th:fragment="additional-css">
    <style>
        .attendance-card {
            transition: transform 0.2s;
        }
        .attendance-card:hover {
            transform: translateY(-2px);
        }
        .student-row {
            border-bottom: 1px solid #dee2e6;
        }
        .student-row:last-child {
            border-bottom: none;
        }
        .attendance-checkbox {
            transform: scale(1.2);
        }
        .status-present {
            background-color: #d4edda !important;
        }
        .status-absent {
            background-color: #f8d7da !important;
        }
        .status-late {
            background-color: #fff3cd !important;
        }
    </style>
</div>

<!-- Additional JS -->
<div th:fragment="additional-js">
    <script th:src="@{/js/popup.js}"></script>
    <script th:src="@{/js/attendance.js}"></script>
    <script>
        // Load classes and set today's date when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadClasses();
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        });

        function loadClasses() {
            const token = MoktobApp.getToken();
            if (!token) {
                window.location.href = '/moktob/login';
                return;
            }

            MoktobApp.apiRequest('/moktob/api/classes')
                .then(classes => {
                    const select = document.getElementById('classSelect');
                    select.innerHTML = '<option value="">Select a class...</option>';
                    
                    if (classes && classes.length > 0) {
                        classes.forEach(cls => {
                            const option = document.createElement('option');
                            option.value = cls.id;
                            option.textContent = `${cls.className} - ${cls.teacherName || 'No Teacher'}`;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading classes:', error);
                });
        }

        function loadClassStudents() {
            const classId = document.getElementById('classSelect').value;
            const date = document.getElementById('attendanceDate').value;
            
            if (!classId || !date) {
                document.getElementById('attendanceFormCard').style.display = 'none';
                document.getElementById('noClassCard').style.display = 'block';
                return;
            }

            const token = MoktobApp.getToken();
            if (!token) {
                window.location.href = '/moktob/login';
                return;
            }

            // Show loading state
            document.getElementById('attendanceFormCard').style.display = 'block';
            document.getElementById('noClassCard').style.display = 'none';
            
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading students...
                    </td>
                </tr>
            `;

            // Load students for the selected class
            MoktobApp.apiRequest(`/moktob/api/classes/${classId}/students`)
                .then(students => {
                    if (students && students.length > 0) {
                        tbody.innerHTML = students.map((student, index) => `
                            <tr class="student-row">
                                <td>${index + 1}</td>
                                <td>${student.name || 'N/A'}</td>
                                <td>${student.guardianName || 'N/A'}</td>
                                <td>${student.guardianContact || 'N/A'}</td>
                                <td class="text-center">
                                    <input type="radio" name="attendance_${student.id}" value="present" class="attendance-checkbox">
                                </td>
                                <td class="text-center">
                                    <input type="radio" name="attendance_${student.id}" value="absent" class="attendance-checkbox">
                                </td>
                                <td class="text-center">
                                    <input type="radio" name="attendance_${student.id}" value="late" class="attendance-checkbox">
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No students found in this class.
                                </td>
                            </tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading students:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error loading students. Please try again.
                            </td>
                        </tr>
                    `;
                });
        }

        function saveAttendance() {
            const classId = document.getElementById('classSelect').value;
            const date = document.getElementById('attendanceDate').value;
            
            if (!classId || !date) {
                MoktobPopup.alert({
                    title: 'Error',
                    message: 'Please select a class and date',
                    type: 'error'
                });
                return;
            }

            const attendanceData = [];
            const attendanceInputs = document.querySelectorAll('input[type="radio"]:checked');
            
            attendanceInputs.forEach(input => {
                const studentId = input.name.split('_')[1];
                attendanceData.push({
                    studentId: parseInt(studentId),
                    status: input.value,
                    date: date
                });
            });

            if (attendanceData.length === 0) {
                MoktobPopup.alert({
                    title: 'Error',
                    message: 'Please mark attendance for at least one student',
                    type: 'error'
                });
                return;
            }

            const token = MoktobApp.getToken();
            if (!token) {
                window.location.href = '/moktob/login';
                return;
            }

            MoktobApp.apiRequest('/moktob/api/attendance', {
                method: 'POST',
                body: JSON.stringify({
                    classId: parseInt(classId),
                    date: date,
                    attendanceRecords: attendanceData
                })
            })
                .then(() => {
                    MoktobPopup.alert({
                        title: 'Success',
                        message: 'Attendance saved successfully',
                        type: 'success'
                    });
                })
                .catch(error => {
                    console.error('Error saving attendance:', error);
                    MoktobPopup.alert({
                        title: 'Error',
                        message: 'Failed to save attendance. Please try again.',
                        type: 'error'
                    });
                });
        }

        function refreshAttendance() {
            loadClasses();
            loadClassStudents();
        }
    </script>
</div>
</body>
</html>
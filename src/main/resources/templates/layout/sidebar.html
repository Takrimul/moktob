<!-- Sidebar Fragment -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" th:fragment="sidebar">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">
            <i class="fas fa-mosque me-2"></i>
            <strong>Moktob</strong>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <nav class="nav flex-column">
            <a class="nav-link" href="/moktob/dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
            <a class="nav-link" href="/moktob/students">
                <i class="fas fa-user-graduate me-2"></i>Students
            </a>
            <a class="nav-link" href="/moktob/teachers">
                <i class="fas fa-chalkboard-teacher me-2"></i>Teachers
            </a>
            <a class="nav-link" href="/moktob/classes">
                <i class="fas fa-school me-2"></i>Classes
            </a>
            <a class="nav-link" href="/moktob/attendance">
                <i class="fas fa-calendar-check me-2"></i>Attendance
            </a>
            <a class="nav-link" href="/moktob/assessments">
                <i class="fas fa-clipboard-check me-2"></i>Assessments
            </a>
            <a class="nav-link" href="/moktob/payments">
                <i class="fas fa-credit-card me-2"></i>Payments
            </a>
            <a class="nav-link" href="/moktob/reports">
                <i class="fas fa-chart-bar me-2"></i>Reports
            </a>

            <hr class="my-3">

            <div class="sidebar-heading px-3">Account</div>
            <a class="nav-link" href="/moktob/profile">
                <i class="fas fa-user-circle me-2"></i>Profile
            </a>
            <a class="nav-link admin-only" href="/moktob/settings" style="display: none;">
                <i class="fas fa-cog me-2"></i>Settings
                <small class="text-muted ms-1">(Admin Only)</small>
            </a>
<!--            <a class="nav-link text-danger" href="/moktob/logout" onclick="return confirmLogout()">-->
<!--                <i class="fas fa-sign-out-alt me-2"></i>Logout-->
<!--            </a>-->
        </nav>
    </div>
</div>

<script>
    function confirmLogout() {
        if (confirm('Are you sure you want to logout?')) {
            return true; // Allow navigation to proceed
        }
        return false; // Prevent navigation
    }

    // Initialize sidebar and add active class based on current URL
    document.addEventListener('DOMContentLoaded', function() {
        // Show sidebar on desktop
        if (window.innerWidth >= 768) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.add('show');
            }
        }

        // Check user role and show/hide admin-only elements
        checkUserRole();

        // Add active class based on current URL
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('.nav-link');
        
        navLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href) {
                // Remove /moktob prefix for comparison
                const linkPath = href.replace('/moktob', '');
                const currentPathClean = currentPath.replace('/moktob', '');
                
                // Check if current path matches the link path
                if (currentPathClean === linkPath || 
                    (linkPath !== '/dashboard' && currentPathClean.startsWith(linkPath))) {
                    link.classList.add('active');
                }
            }
        });
    });

    async function checkUserRole() {
        try {
            // Get user context from the page (if available)
            const userContextElement = document.querySelector('[data-user-context]');
            if (userContextElement) {
                const userContext = JSON.parse(userContextElement.textContent);
                if (userContext && userContext.isAdmin) {
                    showAdminElements();
                }
            } else {
                // Fallback: try to get role from API
                const response = await MoktobApp.apiRequest('/moktob/api/profile');
                if (response && response.roleName && 
                    (response.roleName.toLowerCase().includes('admin') || 
                     response.roleName.toLowerCase().includes('super'))) {
                    showAdminElements();
                }
            }
        } catch (error) {
            console.log('Could not determine user role, hiding admin elements');
        }
    }

    function showAdminElements() {
        const adminElements = document.querySelectorAll('.admin-only');
        adminElements.forEach(element => {
            element.style.display = 'block';
        });
    }
</script>